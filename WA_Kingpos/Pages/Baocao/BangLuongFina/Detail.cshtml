@page
@model WA_Kingpos.Pages.Baocao.BangLuongFina.DetailModel
@using WA_Kingpos.Data
@{
    ViewData["Title"] = "Chi tiết Bảng Lương";
    ViewData["Name"] = "chitietbangluongfina";
}


@functions {
    /// <summary>
    /// Phân biệt đang row show lương của chính nhân viên input hay cấp dưới
    /// </summary>
    private bool IsMine(object? rowMaNhanVien)
    {
        return Model.MaNhanVien == rowMaNhanVien?.ToString();
    }
}




<div class="row">
    <div class="col-12">
        <div class="card card-primary">
            <div class="card-header">
                <h3 class="card-title">@ViewData["Title"]</h3>
            </div>
            <!-- /.card-header -->
            <div class="card-body">
                @*data-sort-order="" data-sort-name=""*@
                <table id="tablefull11" class="table table-bordered table-striped table-sm">
                    <thead>
                        <tr>
                            <th style="text-align:center ; vertical-align:middle">Tên nhân viên</th>
                            @*<th style="text-align:center ; vertical-align:middle">Địa chỉ</th>*@
                            @*<th style="text-align:center ; vertical-align:middle">Ngày nhận việc</th>*@
                            <th style="text-align:center ; vertical-align:middle">Lương căn bản<br>[1]</th>
                            <th style="text-align:center ; vertical-align:middle">SL tiêu chuẩn (kg)</th>
                            <th style="text-align:center ; vertical-align:middle">SL quy đổi (kg)<br>[2]</th>
                            <th style="text-align:center ; vertical-align:middle">Tỷ lệ %</th>
                            <th style="text-align:center ; vertical-align:middle">Đơn vị HH (Đ/kg)<br>[3]</th>
                            <th style="text-align:center ; vertical-align:middle">Hoa Hồng<br>[4]=[2]*[3]</th>
                            <th style="text-align:center ; vertical-align:middle">Chênh lệch Tiền hàng<br>[5]</th>
                            <th style="text-align:center ; vertical-align:middle">Nhóm</th>
                            <th style="text-align:center ; vertical-align:middle">Hình thức</th>
                            <th style="text-align:center ; vertical-align:middle">Khu vực</th>
                    </thead>
                    <tbody>
                        @for (int i = 0; i <= Model.listitem.Count; i++)
                        {
                            if (i < Model.listitem.Count)
                            {
                                var item = Model.listitem[i];
                                <tr>
                                    @* hiển thị đánh dấu là trưởng nhóm*@
                                    <td class="@(item.IS_QUANLY ? "font-weight-bold" : "")">
                                        @item.TENNHANVIEN &nbsp;
                                        <i class="fa fa-key nav-icon icon-leader @(item.MANHANVIEN?.ToString() == Model.MaNhanVien && Model.listitem.Count > 1 ? "" : "d-none")" style="color: #dc3545; " />
                                    </td>

                                    @*<td>@item.DIACHI</td>*@
                                    @*<td>@item.NGAYNHANVIEC?.ToString("dd/MM/yyyy")</td>*@

                                    @*<td class="text-right"><strong>@item.TONGLUONG?.ToString("N0")</strong></td>*@
                                    <td class="text-right">@((IsMine(item.MANHANVIEN) ? item.LUONG_CANBAN : item.LUONG_QUANLY)?.ToString("N0"))</td>
                                    <td class="text-right">@item.DOANHSO_TIEUCHUAN?.ToString("N0")</td>
                                    <td class="text-right">@item.DOANHSO_KPI?.ToString("N0")</td>
                                    <td class="text-right">@((item.TYLE_HOANTHANH)?.ToString("P0"))</td>
                                    <td class="text-right">@((IsMine(item.MANHANVIEN) ? item.DONVI_HH : item.DONVI_HH_QUANLY)?.ToString("N0"))</td>
                                    <td class="text-right">@((IsMine(item.MANHANVIEN) ? item.HH_DOANHSO : item.HH_QUANLY)?.ToString("N0"))</td>
                                    <td class="text-right">@((IsMine(item.MANHANVIEN) ? ExtensionObject.fmNum(item.CHENHLECH_BANHANG)  : ""))</td>
                                    <td>@item.NHOMNHANVIEN</td>
                                    <td>@item.TRANGTHAI_NHANVIEN</td>
                                    <td>@item.KHUVUC_KPI</td>
                                </tr>
                            }
                            else
                            {
                                // footer
                                <tr>
                                    <th>Cộng</th>
                                    <th class="text-right"> @Model.listitem.Sum(item => IsMine(item.MANHANVIEN) ? item.LUONG_CANBAN : item.LUONG_QUANLY)?.ToString("N0")</th>
                                    <th class="d-none"></th>
                                    <th class="d-none"></th>
                                    <th class="d-none"></th>
                                    <th class="d-none"></th>
                                    <th colspan="5" class="text-right">@Model.listitem.Sum(item => IsMine(item.MANHANVIEN) ? item.HH_DOANHSO : item.HH_QUANLY)?.ToString("N0")</th>
                                    <th class="text-right">@ExtensionObject.fmNum(Model.listitem.Sum(item => IsMine(item.MANHANVIEN) ? item.CHENHLECH_BANHANG : 0))</th>
                                    <th colspan="3"></th>
                                    <th class="d-none"></th>
                                    <th class="d-none"></th>
                                </tr>
                                <tr>
                                    <th colspan="11" class="text-md-center text-danger">Tổng Lương: [1]+[4]+[5] &nbsp; = &nbsp;&nbsp;@(Model.listitem[0].TONGLUONG?.ToString("N0"))</th>
                                    <td class="d-none"></td>
                                    <td class="d-none"></td>
                                    <td class="d-none"></td>
                                    <td class="d-none"></td>
                                    <td class="d-none"></td>
                                    <td class="d-none"></td>
                                    <td class="d-none"></td>
                                    <td class="d-none"></td>
                                    <td class="d-none"></td>
                                    <td class="d-none"></td>
                                </tr>
                            }

                        }

                    </tbody>



                    @*<tfoot>
                            <tr>
                                <th>Cộng</th>
                                <th class="text-right"> @Model.listitem.Sum(item => IsMine(item.MANHANVIEN) ? item.LUONG_CANBAN : item.LUONG_QUANLY)?.ToString("N0")</th>
                                <th class="d-none"></th>
                                <th class="d-none"></th>
                                <th class="d-none"></th>
                                <th class="d-none"></th>
                                <th colspan="5" class="text-right">@Model.listitem.Sum(item => IsMine(item.MANHANVIEN) ? item.HH_DOANHSO : item.HH_QUANLY)?.ToString("N0")</th>
                                <th class="text-right">@ExtensionObject.fmNum(Model.listitem.Sum(item => IsMine(item.MANHANVIEN) ? item.CHENHLECH_BANHANG : 0))</th>
                                <th colspan="3"></th>
                                <th class="d-none"></th>
                                <th class="d-none"></th>
                            </tr>
                            <tr>
                                <th colspan="11" class="text-md-center text-danger">Tổng Lương: [1]+[4]+[5] &nbsp; = &nbsp;&nbsp;@(Model.listitem[0].TONGLUONG?.ToString("N0"))</th>
                                <th class="d-none"></th>
                                <th class="d-none"></th>
                                <th class="d-none"></th>
                                <th class="d-none"></th>
                                <th class="d-none"></th>
                                <th class="d-none"></th>
                                <th class="d-none"></th>
                                <th class="d-none"></th>
                                <th class="d-none"></th>
                                <th class="d-none"></th>
                            </tr>
                        </tfoot>*@
                </table>

            </div>
            <!-- /.card-body -->

            <div class="card-footer">
                <a class="btn btn-success" role="button" asp-page="Index" asp-route-id2="@Model.sNgay" asp-route-id4="@Model.strNhomNhanVien">Trở lại danh sách</a>
            </div>
            <!-- /.card-footer -->
        </div>
        <!-- /.card -->
    </div>
    <!-- /.col -->
</div>

<div class="row">
    <div class="col-12">
        <div class="card card-primary">
            <div class="card-header">
                <h3 class="card-title">Chi tiết Doanh số</h3>
            </div>
            <!-- /.card-header -->
            <div class="card-body">
                <table id="tablefull22" class="table table-bordered table-striped table-sm">
                    <thead>
                        <tr>
                            <th style="text-align:center ; vertical-align:middle">Tên nhân viên</th>
                            <th style="text-align:center ; vertical-align:middle">Phiếu đặt hàng</th>
                            <th style="text-align:center ; vertical-align:middle">Ngày thanh toán</th>
                            <th style="text-align:center ; vertical-align:middle">Mặt hàng</th>
                            <th style="text-align:center ; vertical-align:middle">ĐVT</th>
                            <th style="text-align:center ; vertical-align:middle">Số lượng</th>
                            <th style="text-align:center ; vertical-align:middle">Đơn giá</th>
                            @*<th style="text-align:center ; vertical-align:middle">Thành tiền</th>*@
                            <th style="text-align:center ; vertical-align:middle">Giá bảng kê</th>
                            <th style="text-align:center ; vertical-align:middle">Chênh lệch Tiền hàng</th>
                            <th style="text-align:center ; vertical-align:middle">Kho</th>
                            <th style="text-align:center ; vertical-align:middle">HS quy đổi</th>
                            <th style="text-align:center ; vertical-align:middle">SL quy đổi (Kg)</th>
                        </tr>

                    </thead>
                    <tbody>
                        @{

                            string? groupManv = "";
                            string? groupTennv = "";
                            double groupDOANHSO_KPI = 0;
                            double groupCHENHLECH_THANHTIEN = 0;
                        }
                        @for (int i = 0; i <= Model.listDoanhSo.Count; i++)
                        {
                            if (i < Model.listDoanhSo.Count)
                            {
                                var item = Model.listDoanhSo[i];
                                @if (!string.IsNullOrEmpty(groupManv) && item.MANHANVIEN != groupManv)
                                {
                                    // đã qua 1 nhóm khác, chèn 1 dòng tổng cộng
                                    <tr>
                                        <th>Tổng &nbsp;@groupTennv</th>
                                        @*không hiển thị chênh lệch tiền hàng đối với nhân viên cấp dưới*@
                                        <th colspan="8" class="text-right text-danger">@(IsMine(groupManv) ? groupCHENHLECH_THANHTIEN.ToString("N0") : "")</th>
                                        <th class="d-none"></th>
                                        <th class="d-none"></th>
                                        <th class="d-none"></th>
                                        <th class="d-none"></th>
                                        <th class="d-none"></th>
                                        <th class="d-none"></th>
                                        <th class="d-none"></th>
                                        <th colspan="3" class="text-right">@groupDOANHSO_KPI.ToString("N0")</th>
                                        <th class="d-none"></th>
                                        <th class="d-none"></th>
                                    </tr>

                                    groupDOANHSO_KPI = (item.DOANHSO_KPI ?? 0);
                                    groupCHENHLECH_THANHTIEN = (item.CHENHLECH_THANHTIEN ?? 0);
                                }
                                else
                                {
                                    groupDOANHSO_KPI += (item.DOANHSO_KPI ?? 0);
                                    groupCHENHLECH_THANHTIEN += (item.CHENHLECH_THANHTIEN ?? 0);
                                }
                                groupManv = item.MANHANVIEN;
                                groupTennv = item.TENNHANVIEN;
                                <tr>
                                    <td>@item.TENNHANVIEN</td>
                                    <td>@item.PHIEUDENGHI</td>
                                    <td>@item.NGAYTHANHTOAN?.ToString("dd/MM/yyyy")</td>
                                    <td>@item.TEN_HANGHOA</td>
                                    <td>@item.TEN_DONVITINH</td>
                                    <td>@item.SOLUONG?.ToString("N0")</td>
                                    <td class="text-right @(item.DONGIA != item.DONGIA_BANGKE ? "text-danger" : "")">@item.DONGIA?.ToString("N0")</td>
                                    @*<td class="text-right">@item.THANHTIEN?.ToString("N0")</td>*@
                                    <td class="text-right">@item.DONGIA_BANGKE?.ToString("N0")</td>
                                    <td class="text-right @(item.CHENHLECH_THANHTIEN != 0 ? "text-danger" : "")">
                                        @(
                                // không hiển thị chênh lệch tiền hàng đối với nhân viên cấp dưới
                                 IsMine(item.MANHANVIEN) ? ExtensionObject.fmNum(item.CHENHLECH_THANHTIEN) : "")
                                    </td>
                                    <td>@item.TEN_KHO</td>
                                    <td class="text-right">@item.HESOKPI</td>
                                    <td class="text-right">@item.DOANHSO_KPI?.ToString("N0")</td>
                                </tr>
                            }
                            else
                            {
                                // footer
                                <tr>
                                    <th>Tổng &nbsp;@groupTennv</th>
                                    @*không hiển thị chênh lệch tiền hàng đối với nhân viên cấp dưới*@
                                    <th colspan="8" class="text-right text-danger">@(IsMine(groupManv) ? groupCHENHLECH_THANHTIEN.ToString("N0") : "")</th>
                                    <th class="d-none"></th>
                                    <th class="d-none"></th>
                                    <th class="d-none"></th>
                                    <th class="d-none"></th>
                                    <th class="d-none"></th>
                                    <th class="d-none"></th>
                                    <th class="d-none"></th>
                                    <th colspan="3" class="text-right">@groupDOANHSO_KPI.ToString("N0")</th>
                                    <th class="d-none"></th>
                                    <th class="d-none"></th>
                                </tr>
                            }
                        }
                    </tbody>

                </table>

            </div>
            <!-- /.card-body -->
            <div class="card-footer">
            </div>
            <!-- /.card-footer -->
        </div>
        <!-- /.card -->
    </div>
    <!-- /.col -->
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // dữ liệu đang subtotal, không phân trang, không sort
            let tablefull11 = $("#tablefull11").DataTable(createTableProp({ pageLength: 100, ordering: false }));
            let tablefull22 = $("#tablefull22").DataTable(createTableProp({ pageLength: 100, ordering: false }));
            setTimeout(function () {
                // datatable vẽ lệch cột khi có dùng colspan, cần vẽ lại 1 lần để căn chính xác
                tablefull11.draw();
                tablefull22.draw();
            }, 200);
        });
    </script>
}


